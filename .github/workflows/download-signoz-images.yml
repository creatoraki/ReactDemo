name: Download SigNoz Docker Images

on:
  workflow_dispatch:  # 手动触发

jobs:
  download-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install crane
        run: |
          VERSION=v0.19.1
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar xz -C /usr/local/bin/ crane

      - name: Download SigNoz images
        run: |
          mkdir -p signoz-images
          cd signoz-images

          echo "Downloading ClickHouse..."
          crane pull clickhouse/clickhouse-server:24.1.2-alpine clickhouse.tar

          echo "Downloading Zookeeper..."
          crane pull zookeeper:3.7.2 zookeeper.tar

          echo "Downloading SigNoz..."
          crane pull signoz/signoz:v0.87.0 signoz.tar

          echo "Downloading SigNoz OTel Collector..."
          crane pull signoz/signoz-otel-collector:v0.111.42 otel-collector.tar

          echo "Downloading SigNoz Schema Migrator..."
          crane pull signoz/signoz-schema-migrator:v0.111.42 schema-migrator.tar

          ls -lh

      - name: Create archive
        run: |
          cd signoz-images
          tar -czf ../signoz-images.tar.gz *.tar
          cd ..
          ls -lh signoz-images.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signoz-images
          path: signoz-images.tar.gz
          retention-days: 7

      - name: Create Release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: signoz-images-${{ github.run_number }}
          name: SigNoz Images (${{ github.run_number }})
          body: |
            SigNoz Docker Images Bundle

            包含的镜像（基于 /opt/signoz/deploy/docker/docker-compose.yaml）:
            - clickhouse/clickhouse-server:24.1.2-alpine
            - zookeeper:3.7.2 (Apache 官方镜像,替代 bitnami/zookeeper:3.7.1)
            - signoz/signoz:v0.87.0
            - signoz/signoz-otel-collector:v0.111.42
            - signoz/signoz-schema-migrator:v0.111.42

            注意: 下载后需要重新打标签以匹配 docker-compose.yaml:
            docker tag zookeeper:3.7.2 bitnami/zookeeper:3.7.1

            下载后在服务器上执行:
            ```bash
            # 1. 下文件到服务器
            cd /opt/signoz
            mkdir -p images
            cd images
            wget https://github.com/你的用户名/org-efficiency-platform/releases/download/signoz-images-xxx/signoz-images.tar.gz

            # 2. 解压
            tar -xzf signoz-images.tar.gz

            # 3. 导入镜像
            docker load -i clickhouse.tar
            docker load -i zookeeper.tar
            docker load -i signoz.tar
            docker load -i otel-collector.tar
            docker load -i schema-migrator.tar

            # 4. 验证镜像已导入
            docker images | grep -E "clickhouse|zookeeper|signoz"

            # 5. 启动 SigNoz
            cd /opt/signoz/deploy
            ./install.sh
            ```
          files: signoz-images.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
